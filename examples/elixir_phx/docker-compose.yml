---
services:
  # WIP: only using regular mix app at this time!!
  elixir_phx:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    environment:
      OTEL_SERVICE_NAME: "elixir-phx-dice-server"
      OTEL_SERVICE_VERSION: "0.1.0"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4318
      OTEL_METRIC_EXPORT_INTERVAL: "5000" # so we don't have to wait 60s for metrics
      MIX_ENV: dev
      PHX_SERVER: true
      ERL_AFLAGS: -kernel shell_history enabled
      DB_HOST: db
      # Database is optional for this example, but keeping for completeness
      # DATABASE_URL: ecto://postgres:postgres@db:5432/elixir_phx_dev
    ports:
      - "4000:4000"
    depends_on:
      db:
        condition: service_healthy

  # docker compose exec -it db psql -U postgres
  # docker compose up db --remove-orphans -d
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: elixir_phx_dev
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data

  traffic:
    image: curlimages/curl:8.10.1
    depends_on:
      - elixir_phx
    command:
      - sh
      - -c
      - |
        echo "Generating traffic to Elixir Phoenix dice server...";
        COUNTER=0;
        while true; do
          COUNTER=$((COUNTER + 1));
          
          # === FAST BUT FREQUENT (high traffic, low latency) ===
          # These are called very often to create high-impact but fast queries
          curl -s http://host.docker.internal:4000/rolldice/6 > /dev/null;
          
          # === MIXED PATTERNS (regular calls with different dice sides) ===
          # Called regularly to create diverse trace patterns
          curl -s http://host.docker.internal:4000/rolldice/12 > /dev/null;
          
          # === SLOW BUT RARE (low traffic, high latency) ===
          # Called infrequently to create varied traffic patterns
          if [ $((COUNTER % 20)) -eq 0 ]; then
            echo "Generating some slow requests to create high-latency traces...";
            echo "";
            curl -s http://host.docker.internal:4000/rolldice/100 > /dev/null;
            curl -s http://host.docker.internal:4000/api/dice/50 > /dev/null;

          fi
          if [ $((COUNTER % 30)) -eq 0 ]; then
            echo "Generating some invalid requests to create errors and exceptions in traces/logs...";
            echo "";
            curl -s http://host.docker.internal:4000/rolldice/abc > /dev/null;
          fi
          if [ $((COUNTER % 50)) -eq 0 ]; then
            curl -s http://host.docker.internal:4000/rolldice/1000 > /dev/null;
          fi
          
        done

volumes:
  postgres_data:
